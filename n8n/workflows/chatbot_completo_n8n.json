{
  "name": "Chatbot Tributos - Completo n8n",
  "nodes": [
    {
      "parameters": {
        "path": "94a8adfc-1dba-41e7-be61-4c13b51fa08e",
        "options": {}
      },
      "id": "waha-trigger",
      "name": "WAHA Trigger",
      "type": "n8n-nodes-waha.wahaTrigger",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.payload.from }}",
              "operation": "contains",
              "value2": "@g.us"
            }
          ]
        }
      },
      "id": "filter-groups",
      "name": "Filtrar Grupos",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {},
      "id": "stop-group",
      "name": "Ignorar (Grupo)",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [650, 200]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "chat_id",
              "name": "chat_id",
              "value": "={{ $json.payload.from }}",
              "type": "string"
            },
            {
              "id": "message",
              "name": "message",
              "value": "={{ $json.payload.body || $json.payload.text || '' }}",
              "type": "string"
            },
            {
              "id": "event",
              "name": "event",
              "value": "={{ $json.event || 'message' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "extract-data",
      "name": "Extrair Dados",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [650, 400]
    },
    {
      "parameters": {
        "url": "http://waha:3000/api/default/chats/typing",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "headerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"session\": \"default\",\n  \"chatId\": \"{{ $json.chat_id }}\",\n  \"typing\": true\n}",
        "options": {
          "ignoreResponseCode": true
        }
      },
      "id": "start-typing",
      "name": "Iniciar Typing",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [850, 400],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "http://api:5000/chatbot/webhook/",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"event\": \"{{ $json.event }}\",\n  \"payload\": {\n    \"from\": \"{{ $json.chat_id }}\",\n    \"body\": \"{{ $json.message }}\"\n  }\n}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "call-api",
      "name": "Chamar API Python",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "jsCode": "// Extrair resposta da API\nconst apiResponse = $input.first().json;\n\n// A API retorna { response: \"texto\" } ou { success: true, response: \"texto\" }\nconst response = apiResponse.response || apiResponse.message || 'Desculpe, não consegui processar sua mensagem.';\nconst chat_id = $('Extrair Dados').first().json.chat_id;\n\nreturn [{ json: { response, chat_id } }];"
      },
      "id": "extract-response",
      "name": "Extrair Resposta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "url": "http://waha:3000/api/sendText",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "headerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"session\": \"default\",\n  \"chatId\": \"{{ $json.chat_id }}\",\n  \"text\": \"{{ $json.response }}\"\n}",
        "options": {}
      },
      "id": "send-response",
      "name": "Enviar Resposta WAHA",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1450, 400]
    },
    {
      "parameters": {
        "url": "http://waha:3000/api/default/chats/typing",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "headerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"session\": \"default\",\n  \"chatId\": \"{{ $('Extrair Dados').first().json.chat_id }}\",\n  \"typing\": false\n}",
        "options": {
          "ignoreResponseCode": true
        }
      },
      "id": "stop-typing",
      "name": "Parar Typing",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1650, 400],
      "continueOnFail": true,
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "url": "http://waha:3000/api/default/chats/typing",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "headerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"session\": \"default\",\n  \"chatId\": \"{{ $('Extrair Dados').first().json.chat_id }}\",\n  \"typing\": false\n}",
        "options": {
          "ignoreResponseCode": true
        }
      },
      "id": "stop-typing-error",
      "name": "Parar Typing (Erro)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 550],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "http://waha:3000/api/sendText",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "headerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"session\": \"default\",\n  \"chatId\": \"{{ $('Extrair Dados').first().json.chat_id }}\",\n  \"text\": \"Desculpe, ocorreu um erro ao processar sua mensagem. Por favor, tente novamente ou entre em contato com a Secretaria de Finanças pelo telefone (47) 3267-8000.\"\n}",
        "options": {}
      },
      "id": "send-error",
      "name": "Enviar Mensagem de Erro",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1450, 550]
    }
  ],
  "connections": {
    "WAHA Trigger": {
      "main": [
        [
          {
            "node": "Filtrar Grupos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtrar Grupos": {
      "main": [
        [
          {
            "node": "Ignorar (Grupo)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extrair Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair Dados": {
      "main": [
        [
          {
            "node": "Iniciar Typing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Iniciar Typing": {
      "main": [
        [
          {
            "node": "Chamar API Python",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chamar API Python": {
      "main": [
        [
          {
            "node": "Extrair Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Parar Typing (Erro)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair Resposta": {
      "main": [
        [
          {
            "node": "Enviar Resposta WAHA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Resposta WAHA": {
      "main": [
        [
          {
            "node": "Parar Typing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parar Typing (Erro)": {
      "main": [
        [
          {
            "node": "Enviar Mensagem de Erro",
            "type": "main",
            "index": 0
          }
        ]